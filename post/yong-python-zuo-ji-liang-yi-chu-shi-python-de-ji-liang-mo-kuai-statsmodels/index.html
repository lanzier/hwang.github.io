<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> 用 Python 做计量 （一）—— 初识Python 的计量模块： Statsmodels  | Hwang&#39;s Blog</title>
<meta name="description" content="欢迎来到 Hwang 的小博客 <br>
这显然不是什么技术博客，也不会有太多值得期待的干货。<br>" />
<link rel="shortcut icon" href="https://hwang.top/favicon.ico?v=1582024358668">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://hwang.top/styles/main.css">

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://hwang.top">
  <img class="avatar" src="https://hwang.top/images/avatar.png?v=1582024358668" alt="">
  </a>
  <h1 class="site-title">
    Hwang&#39;s Blog
  </h1>
  <p class="site-description">
    欢迎来到 Hwang 的小博客 <br>
这显然不是什么技术博客，也不会有太多值得期待的干货。<br>
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
               用 Python 做计量 （一）—— 初识Python 的计量模块： Statsmodels 
            </h2>
            <div class="post-info">
              <span>
                2019-07-16
              </span>
              <span>
                10 min read
              </span>
              
                <a href="https://hwang.top/tag/oEltlpWF3" class="post-tag">
                  # Python
                </a>
              
                <a href="https://hwang.top/tag/w0VIrv_ivr" class="post-tag">
                  # 数据Seminar
                </a>
              
                <a href="https://hwang.top/tag/CjydnGrXlu" class="post-tag">
                  # 长文
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://hwang.top/post-images/yong-python-zuo-ji-liang-yi-chu-shi-python-de-ji-liang-mo-kuai-statsmodels.png" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <blockquote>
<p>本文发布于 「 数据Seminar 」公众号：https://mp.weixin.qq.com/s?src=11&amp;timestamp=1569839526&amp;ver=1884&amp;signature=hxZrP-JJKRnGggkDaM2PDBJc7DJsrqQWkpBciqqbDAEeqjNhRKIc37VK4bPqNUKSDjtXPGV0yto99QK5ywqoagPK1PhKPC0dynzFMNVchJWrQG5X3VUMMBadcyBnh7hi&amp;new=1</p>
</blockquote>
 <script type="text/x-mathjax-config">
 MathJax.Hub.Config({tex2jax: {inlineMath:[['$','$']]}});
 </script>
 <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<blockquote>
<p>阅读本文前需要掌握的基础知识：<br>
Python 的基础知识、 numpy 的基础知识、 pandas 的基础知识<br>
基本的计量知识<br>
如果你还不会，那么本文也会介绍一些 python 语法的基础内容，方便大家理解。</p>
</blockquote>
<p>随着数据资源的日渐丰富，学者们越来越多的需要接触到大数据的处理，许多学者还是习惯使用 Stata 对数据进行处理，而 Stata 由于其自身的限制，在处理大数据集时要么需要强劲的处理性能（昂贵的硬件成本），要么需要等待较长时间（更加昂贵的时间成本）。Python 和 R 也就日渐进入学者的视野，相对于 R ，Python 的语法更为简单，成为一部分学者的首选。</p>
<p>在数据处理上，numpy 和 pandas 的组合，使得 Python 能够轻松应对千万级别的数据处理。在攻克数据处理这一环后，在数据应用上，除了新潮的机器学习、深度学习的方法，对于现阶段社科学者来说，计量可能才是最现实的。在 Python 中处理的数据如果还需要调回到 Stata 中做计量，那未免太「蹩脚」。今天，数据Seminar 公众号将带大家体验 Python 上的第三方计量库：<a href="https://www.statsmodels.org/stable/index.html">Statsmodels</a> 。</p>
<h2 id="简介">简介</h2>
<p>Statsmodels 是一个Python的第三方模块，他封装了许多计量模型，方便学者直接调用。所谓封装，就相当于 Stata 中一个 <code>reg</code> 命令，代表了最基础的 OLS 回归命令，在Statsmodels 中也有类似 <code>reg</code> 的语句，提供给 OLS 估计。另外 Statsmodels 的开源协议为 <a href="https://baike.baidu.com/item/BSD%E8%AE%B8%E5%8F%AF%E5%8D%8F%E8%AE%AE">BSD </a>（基本上对于用户来说属于为所欲为协议，你可以任意使用这款扩张包，具体参见链接地址）。</p>
<blockquote>
<p>statsmodels is a Python module that provides classes and functions for the estimation of many different statistical models, as well as for conducting statistical tests, and statistical data exploration. An extensive list of result statistics are available for each estimator. The results are tested against existing statistical packages to ensure that they are correct. The package is released under the open source Modified BSD (3-clause) license. The online documentation is hosted at statsmodels.org.</p>
</blockquote>
<h2 id="安装">安装：</h2>
<p>如果你使用 Anaconda 安装的 python ，那么：</p>
<pre><code class="language-bash">conda install statsmodels
</code></pre>
<p>如果你使用 pip 管理你的python包，那么：</p>
<pre><code class="language-bash">pip install statsmodels # python2 
</code></pre>
<p>或者：</p>
<pre><code class="language-bash">pip3 install statsmodels #python3
</code></pre>
<h2 id="精读代码初探ols">“精读”代码，初探：OLS</h2>
<p>官方的说明文档：<a href="http://www.statsmodels.org/stable/gettingstarted.html">http://www.statsmodels.org/stable/gettingstarted.html</a></p>
<p>首先先看了一下 OLS 的示例：</p>
<pre><code class="language-python">import numpy as np
import statsmodels.api as sm
import statsmodels.formula.api as smf

dat = sm.datasets.get_rdataset(&quot;Guerry&quot;, &quot;HistData&quot;).data
results = smf.ols('Lottery ~ Literacy + np.log(Pop1831)', data=dat).fit()
print(results.summary())
</code></pre>
<p>运行后：<br>
<img src="DraggedImage.png" alt="" loading="lazy"><br>
*(本文采用的编辑器为 Google 的 colab) *</p>
<p>是的，OLS就是这么几行，具体来看内容，其实进行 OLS 回归只需要一行内容。为了方便 Python 基础不那么好的同学，我们驻行“精读”一遍这些代码：</p>
<h3 id="1-导入模块">1. 导入模块</h3>
<pre><code class="language-python">import numpy as np
import statsmodels.api as sm
import statsmodels.formula.api as smf
</code></pre>
<p>首先是需要导入 numpy、statsmodels 的相关模块，numpy 推荐的缩写命名 np，statsmodels 推荐的缩写命名是 sm，这样后面的代码就可以通过 <code>np.[具体的函数\方法]</code> ，<code>sm. [具体的函数\方法]</code> 的方式来更加简洁的调用了。</p>
<h3 id="2-生成测试数据集">2. 生成测试数据集</h3>
<pre><code class="language-python">dat = sm.datasets.get_rdataset(&quot;Guerry&quot;, &quot;HistData&quot;).data
</code></pre>
<p>由于并没有现成数据，我们可以通过 statsmodels 中自带的数据集，关于该数据集的具体信息可以参考：<a href="https://vincentarelbundock.github.io/Rdatasets/doc/HistData/Guerry.html">https://vincentarelbundock.github.io/Rdatasets/doc/HistData/Guerry.html</a>，简单来说，这是一个关于犯罪、识字等相关内容的社会科学领域的数据集。<br>
<img src="DraggedImage-1.png" alt="" loading="lazy"></p>
<p>这个数据集以DataFrame 格式的储存在了 <code>dat</code> 这个变量中。 DataFrame 格式在 Python 中被广泛的使用，可以说无论是机器学习还是本文介绍的计量相关内容，DataFrame 格式相关的操作都需要熟练掌握。关于 DataFrame 的相关内容，需要更加细致的去学习Python的另一个第三方库 pandas ，本文不再赘述。</p>
<h3 id="3-回归操作">3. 回归操作</h3>
<pre><code class="language-python">results = smf.ols('Lottery ~ Literacy + np.log(Pop1831)', data=dat).fit()
</code></pre>
<p>首先是<code>smf.ols</code>， <code>smf</code> 就是前面的 <code>statsmodels.formula.api</code> ，OLS 回归的方法在 <code>statsmodels.formula.api</code>下，如果前文没有声明 <code>smf</code> 代表<code>statsmodels.formula.api</code> 的话，你这里可就要写成 <code>statsmodels.formula.api.ols</code> 了，可见合理的缩写声明对于代码的简洁美观非常有帮助。</p>
<p>接下来是括号内的内容<code>('Lottery ~ Literacy + np.log(Pop1831)', data=dat)</code><br>
这其实是<code>OLS</code>模型需要传入的参数，以<code>,</code>为区隔，第一个参数是回归模型，第二个参数是数据。</p>
<p>在这行代码中，回归模型是：<code>'Lottery ~ Literacy + np.log(Pop1831)'</code>，数据是前面加载的<code>dat</code> ，比较方便的是，<code>statsmodels</code>，直接从数据<code>dat</code>中读取了变量名称，并不需要进行额外的赋值操作。我们具体看一下这个模型的写法，对于没有接触过 Python 和 R 的读者来说，这种写法可能相对有些陌生，其实这个模型代表了：</p>
<figure data-type="image" tabindex="1"><img src="DraggedImage-2.png" alt="" loading="lazy"></figure>
<p>这种写法参考了R的相关内容，具体是由 Python 中的 Patsy 库实现的。上面这个就是一个计量模型（他当然不是计算 <code>Literacy + np.log(Pop1831)</code>的和，<code>Literacy</code> 和 <code>np.log(Pop1831)</code> 都是矩阵）。这就和 Stata 中 <code>reg y x0 x1 x2</code> 是一样，只是在Python 中模型需要写成<code>y~x0+x1+x2</code>，而 reg 需要写成 <code>smf.ols()</code>。</p>
<p>这个模型中还用到了一个知识点：<code>np.log</code> ，就是说引用了 numpy 中的 log 函数，对变量<code>Pop1831</code> 取对数，就是使用 numpy 进行 log 运算。 如果你直接写 <code>log(Pop1831)</code>，Python是不知道 log 是做什么的，所以要告诉 Python，这个 log 来自于 numpy，这样 Python 就能正常处理 <code>Pop1831</code> 这个数据切片（“切片” 是Python数据处理中常用名词，可以理解为一个 DataFrame 的一列、一行或者几列、几行的数据）了。</p>
<p>最后 <code>data=dat</code> 就是声明对于这个模型，使用的数据时 <code>dat</code>， 这样前面的模型中的 <code>Lottery</code> 、<code>Literacy</code> 和 <code>Pop1831</code>，statsmodels 都能智能的去从 DataFrame 切片（切片操作需要学习Pandas哦），然后应用到模型中。</p>
<p>括号内的内容就是进行回归操作的核心。</p>
<p>括号外还有<code>.fit()</code>，就是告诉 Python，可以进行回归计算了。如果没有这个<code>.fit()</code> ，Python 只会记录这个模型和相关的数据信息，而添加了<code>.fit()</code>，记录时回归后的结果。<br>
<img src="DraggedImage-3.png" alt="" loading="lazy"><br>
（上图可以看到储存在计算机中的内容是有差异的）</p>
<p>同样，<code>.fit()</code> 后输出的结果也并非像 Stata 那样那样直接输出的事结果，而是将结果储存，可以进行多种方式的调用。</p>
<p>如果想输入结果，那么就使用 <code>results.summary()</code> ，将其打印出来，正如示例中展示的那样：</p>
<figure data-type="image" tabindex="2"><img src="DraggedImage-4.png" alt="" loading="lazy"></figure>
<h2 id="ols-实例">OLS 实例</h2>
<p>这里简单演示一下 OLS 回归，数据处理这一部分内容，在 Python 中主要使用 numpy 和 pandas，这里就不演示，本文直接读取处理完的数据来演示 OLS 的内容：</p>
<p>本文的数据来自CFPS，主要研究的内容是子女认知能力和服务是否创业的关系，处理后的第一个回归模型的内容主要是，母亲的创业状态（<code>self_employed_m_16</code>），教育年限(<code>edu</code>)，是否参加课外补习(<code>extra_classes</code>)，家庭药品支出(<code>expend_medical</code>)、自评健康状况(<code>health</code>)、家庭氛围(<code>quarrel</code>)、与母亲同住时长(<code>livewith_m</code>)、与父亲同住时常(<code>livewith_f</code>)、log的家庭收入(<code>lg_fin</code>)、子女数量(<code>num_chd</code>)、母亲的受教育程度(<code>edu_m</code>)、父亲的受教育程度(<code>edu_f</code>)、户口(<code>hukou</code>)、东中西部虚拟变量（<code>east 、 west</code>），然后被解释变量就是认知能力(<code>y_rznl</code>)。</p>
<pre><code class="language-python">import numpy as np
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf

df = pd.read_csv(&quot;testing.csv&quot;)
OLS_1 = smf.ols(&quot;y_rznl~ self_employed_m_16 + edu + extra_classes + \
    expend_medical + health + quarrel + livewith_m + livewith_f + \
    lg_fin + num_chd + edu_m + edu_f + hukou + east + west&quot;, data=df).fit()
print(OLS_1.summary())
</code></pre>
<p>最后输出结果：<br>
<img src="%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-07-07%20%E4%B8%8B%E5%8D%883.04.11.png" alt="" loading="lazy"></p>
<p>而stata输出的结果（置信区间是97.5%）：<br>
<img src="%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-07-07%20%E4%B8%8B%E5%8D%883.11.40.png" alt="" loading="lazy"></p>
<p>可以看到，结果基本一致。</p>
<p>最后，在OLS这里案例中，可以看到 Python 输出结果基本与 Stata 相同，在代码的撰写上， Python 同样非常方便，并且由于 Python 是一门编程语言，在一些循环的撰写上非常有优势，例如我需要多次循环某几个变量，以及对应的被解释变量：</p>
<pre><code class="language-python">import numpy as np
import pandas as pd
import statsmodels.api as sm
import statsmodels.formula.api as smf

df = pd.read_csv(&quot;testing.csv&quot;)
y_list =[y1, y2, y3, y4] # 被解释变量的列表
x0_list = [x0_1, x0_2, x0_3, x0_4, x0_5] # 某一个解释变量的列表
model_list = []
for y in y_list:
	for x0 in x0_list:
		model = &quot;%s ~ %s + edu + extra_classes + \
    expend_medical + health + quarrel + livewith_m + livewith_f + \
    lg_fin + num_chd + edu_m + edu_f + hukou + east + west&quot; % (y, x0)
		OLS = smf.ols(model, data = df).fit()
		print(OLS.summary())
		
</code></pre>
<p>这样就能一次性依次输出，以下内容的回归结果：</p>
<ul>
<li>
<p><code>y1 = x0_1 + edu + extra_calsses +...</code></p>
</li>
<li>
<p><code>y1 = x0_2 + edu + extra_calsses +...</code></p>
</li>
<li>
<p><code>y1 = x0_3 + edu + extra_calsses +...</code><br>
…</p>
</li>
<li>
<p><code>y1 = x0_5 + edu + extra_calsses +...</code></p>
</li>
<li>
<p><code>y2 = x0_1 + edu + extra_calsses +...</code></p>
</li>
<li>
<p><code>y2 = x0_2 + edu + extra_calsses +...</code><br>
…</p>
</li>
<li>
<p><code>y2 = x0_5 + edu + extra_calsses +...</code><br>
…</p>
</li>
<li>
<p><code>y4 = x0_5 + edu + extra_calsses +...</code></p>
</li>
</ul>
<p>所以无论是数据处理还是计量回归中，都能给你极大的便利。</p>
<p>相比Stata，Python  是免费开源的，不需要额外的授权费用，并且如果志在机器学习，那么先从相对熟悉的计量入手或许是一个不错的选择。</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%AE%80%E4%BB%8B">简介</a></li>
<li><a href="#%E5%AE%89%E8%A3%85">安装：</a></li>
<li><a href="#%E7%B2%BE%E8%AF%BB%E4%BB%A3%E7%A0%81%E5%88%9D%E6%8E%A2ols">“精读”代码，初探：OLS</a>
<ul>
<li><a href="#1-%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97">1. 导入模块</a></li>
<li><a href="#2-%E7%94%9F%E6%88%90%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E9%9B%86">2. 生成测试数据集</a></li>
<li><a href="#3-%E5%9B%9E%E5%BD%92%E6%93%8D%E4%BD%9C">3. 回归操作</a></li>
</ul>
</li>
<li><a href="#ols-%E5%AE%9E%E4%BE%8B">OLS 实例</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://hwang.top/post/ru-he-zai-windows-de-gong-xiang-wen-jian-jia-zhong-chuang-jian-wen-jian-tu-biao">
              <h3 class="post-title">
                如何 在 Windows 的共享文件夹中创建文件图标
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | 
  <a class="rss" href="https://hwang.top/atom.xml" target="_blank">RSS</a>
</div>

<script>
  hljs.initHighlightingOnLoad()

  let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

  // This should probably be throttled.
  // Especially because it triggers during smooth scrolling.
  // https://lodash.com/docs/4.17.10#throttle
  // You could do like...
  // window.addEventListener("scroll", () => {
  //    _.throttle(doThatStuff, 100);
  // });
  // Only not doing it here to keep this Pen dependency-free.

  window.addEventListener("scroll", event => {
    let fromTop = window.scrollY;

    mainNavLinks.forEach((link, index) => {
      let section = document.getElementById(decodeURI(link.hash).substring(1));
      let nextSection = null
      if (mainNavLinks[index + 1]) {
        nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
      }
      console.log('section.offsetHeight', section.offsetHeight);
      if (section.offsetTop <= fromTop) {
        if (nextSection) {
          if (nextSection.offsetTop > fromTop) {
            link.classList.add("current");
          } else {
            link.classList.remove("current");    
          }
        } else {
          link.classList.add("current");
        }
      } else {
        link.classList.remove("current");
      }
    });
  });

</script>

      </div>
    </div>
  </body>
</html>
